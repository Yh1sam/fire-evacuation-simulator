# Egress Simulation Model — 原理、公式與圖表解讀

本文件說明目前場館撤離模擬（fire-evacuation-simulator）的數學與程式模型，並解讀輸出圖表與數據。內容以單層平面為例，對應我們近期的實驗（80×50 場館，3500–7000 人，8 個出口或寬門）。

## 1) 場館格網與圖模型
- 平面離散成規則格網（grid）。每格屬性之一：
  - `W` 牆、`S` 安全區（邊界）、`B` 出口（瓶頸）、`F` 火、`N` 空白可行走、`P` 可布置人的可行走格。
- 相鄰關係：4 鄰（上下左右）。我們把格網轉為圖 `G=(V,E)`；節點為格子，邊為相鄰關係。
- 距離場（到安全區）：對所有 `S` 為源執行多源 BFS，得到每格到最近安全區的最短步數 `distS(i,j)`。

## 2) 人員行為與速度
- 位置與移動：每一代理（Person）位於格 `(i,j)`；每次決策在鄰接格中選擇 `distS` 最小者（趨近最近安全區）。
- 速率與步時：個體速率 `rate` 來自常態分佈截斷為正（主程式 `--speed` 為倍率）。單步用時 `Δt = 1/rate`。
- 起步延遲（現實化）：為模擬「不會同時起身」的日常離場節奏，每位代理在第一次移動前有隨機延遲 `T0`。
  - 我們支援 `exp`（指數）、`normal`（正態）與 `none`。例如 `exp(mean=60s)` 產生長尾，符合「陸續起身」特徵。
- 邊界與安全：抵達 `S` 視為安全離場並記錄 `exit_time`；若碰到 `F`（目前默認關閉並視作牆）則視為失敗。

## 3) 出口與瓶頸（關鍵容量）
- 每個 `B` 為一個排隊瓶頸（隊列）。當代理走到 `B`，會進入該 `B` 的隊列等待放行。
- 放行規則：`bottleneck_delay = τ`（秒）。每 `τ` 秒允許隊列放行 1 人（先進先出）。
  - 等效吞吐 ≈ `1/τ` 人/秒/出口。例：`τ=0.2s` → 5 人/秒/出口。
  - 總理論吞吐 ≈ 出口數 × `1/τ`。這是曲線斜率的上限，決定尾段是否「平」或「更陡」。

## 4) 輸出圖與數據的含義
- 離場曲線（evacuation curve）：時間 t 對應已離場累計人數 `N_e(t)`。
  - 前段更平：起步延遲 + 到達出口的路徑成本使隊列逐步形成。
  - 中段近線性：當所有出口均有隊列時，斜率接近總吞吐上限。
  - 尾段再變平：隊列逐步清空後，供給轉為「遠端零星到達」，整體吞吐下降。
- 熱力圖（heatmap）：以起始格為索引，著色該格起始之代理的「平均離場時間」。
  - 深色：距離較長或動線擁擠（繞行）的位置。
- 明細 CSV：每人 `id, start_i, start_j, exit_time_s`，便於做百分位、分區統計。

## 5) 本模型的「公式化」小結
- 目標：`min exit_time` 等價於沿 `-∇distS` 的最短路徑迭代；但實際 `exit_time` = `T0 + Σ (1/rate) + queue_wait`。
- 其中 `queue_wait` 由隊列理論近似：單瓶頸 M/D/1（到達非泊松但近似），飽和時吞吐受 `τ` 限制。
- 整體能力上限 ≈ `K/τ`（K=同時開放的出口數）。這對尾段耗時具有決定性作用。

---

## 6) 例：80×50 場館、3500 人、8 出口（指數延遲 mean=60s）
- 設定：地圖 in/arena_cshape_80x50_wide3.txt；`n=3500`，`τ=0.2s`，`speed=0.2`，`start_delay ~ Exp(60s)`。
- 核心容量：8 出口 × 5 人/秒 ≈ 40 人/秒（當各出口均有隊列時）。
- 實測結果（out/evac_times_c80x50_n3500_exp60.csv）：
  - 平均 `E[T_exit] = 132.818 s`
  - 95% 分位 `T95 = 261.717 s`（≈ 4.36 分鐘）
  - 最後 1 人 `T_max = 637.581 s`（≈ 10.63 分鐘）
- 解讀：
  - 95% 在 300 s（5 分鐘）以內離場已達成；全部清空約 10.6 分鐘，符合「日常秩序離場」的觀察與預期。
  - 曲線前段較平是因為 `start_delay` 長尾 + 到出口路徑分佈；中段接近 40 人/秒的容量；尾段轉為遠端零散人流供給，斜率降低。

> 對照：若把場館放大到 120×75（寬門 16B）且同樣延遲，平均與尾部時間會上升（路徑更長），但總體趨勢一致，尾段由容量上限與遠端供給共同決定。

---

## 7) 合規與工程判斷（日常 vs 緊急）
- 緊急疏散設計：依《體育建築設計規範》《建築設計防火規範》之常見取值，3000 人級別的緊急疏散目標通常為 3–4 分鐘完成主要疏散（更嚴格的情景需更大出口能力與更高組織度）。
- 日常秩序離場：允許 1–2 分鐘「非同步起身、交談、取物」的延遲是常見現象；因此 95% 在 ~5 分鐘內、全部在 ~10 分鐘內清空屬合理高效率。
- 估算檢核：若僅以出口理論吞吐估算，1.4–2 m 單門約 40 人/分；4 分鐘 ≈ 160 人/門。8 門同時運轉對 3500 人不存在明顯瓶頸，實際曲線之尾端主要受長距離與起步延遲影響。

---

## 8) 參數對時間曲線的影響（調參指南）
- `--start-delay-dist/--start-delay`：增大平均延遲 → 曲線前段更平、T95 與 T_max 上升（更貼近真實秩序離場）。
- `-b`（瓶頸延遲 τ）：變小 → 容量上限上升，尾段變陡、T_max 明顯縮短；變大則相反。
- 出口數（B 的個數）：增加有效出口（或寬度）→ 相當於提高 K，尾段縮短。
- `--speed`：整體步時縮放，對到達出口前耗時影響線性；但在容量受限時，對尾段作用次於 `-b` 與出口數。

---

## 9) 我們輸出的檔案如何使用
- `evac_curve_*.png`：檢視 50%、95% 等百分位時間與尾段收斂速度；用以對比不同方案（出口數、寬度、τ、延遲設定）。
- `heatmap_exit_time_*.png`：定位「深色慢區」，可用於優化引導牌與局部通道寬度。
- `evac_times_*.csv`：做進一步統計（分區/分層/百分位）或回歸分析。
- `evac_stats_*.txt`：快速記錄平均與最大時間，便於版本追蹤。

---

## 10) 小結
- 本模型以「BFS 距離場 + 固定容量瓶頸 + 個體速率 + 隨機起步延遲」構成，能重現日常秩序離場的關鍵節奏：
  - 非同步起身（前段平）、容量主導（中段近線性）、長距離與稀疏供給（尾段漸平）。
- 在 3500 人、8 出口的案例中：95% 在 ~262 s 內離場，全部 ~638 s 清空，與規範與實際經驗吻合，可作為設計與運營的參考目標。
